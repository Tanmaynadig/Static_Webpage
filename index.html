<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Currency Comparison</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for the graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Simple transition for page switching */
        .page { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="p-4">

    <!-- Main Page: List of currencies -->
    <div id="main-page" class="page w-full max-w-2xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Currency Dashboard</h1>
            <!-- New Grid Layout for Currency Cards -->
            <div id="currency-list-container" class="grid grid-cols-2 gap-4">
                <!-- Cards will be injected here by JavaScript -->
                <p class="col-span-2 text-center text-gray-500">Loading live currency data...</p>
            </div>
        </div>
    </div>

    <!-- Detail Page: Chart and comparison -->
    <div id="detail-page" class="page w-full max-w-4xl mx-auto hidden">
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <!-- Header with Back Button and Title -->
            <div class="flex items-center mb-2">
                <button id="back-button" class="p-2 rounded-full hover:bg-gray-200 mr-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                </button>
                <div>
                    <h2 id="chart-title" class="text-xl font-bold text-gray-800">Comparison Chart</h2>
                    <div id="percentage-change" class="text-sm font-semibold"></div>
                </div>
            </div>

            <!-- Controls: Currency Selector -->
            <div class="flex justify-end items-center my-6">
                <div class="flex items-center">
                    <span class="mr-2 text-gray-600">Compare INR with:</span>
                    <select id="currency-selector" class="p-2 border rounded-md bg-gray-50"></select>
                </div>
            </div>
            
            <!-- Chart Container -->
            <div class="relative h-64 md:h-80">
                 <div id="chart-loading" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-75 z-10">
                    <p class="text-gray-600">Loading chart data...</p>
                </div>
                <canvas id="historyChart"></canvas>
            </div>
            
            <!-- Timeframe Selector (Moved Below Chart) -->
            <div id="timeframe-selector" class="flex justify-center space-x-2 mt-4">
                <button data-range="1Y" class="timeframe-btn bg-blue-500 text-white px-3 py-1 rounded-md text-sm">1Y</button>
                <button data-range="5Y" class="timeframe-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm">5Y</button>
                <button data-range="ALL" class="timeframe-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-md text-sm">All</button>
            </div>
        </div>
    </div>

    <script>
        const mainPage = document.getElementById('main-page');
        const detailPage = document.getElementById('detail-page');
        const backButton = document.getElementById('back-button');
        const currencyListContainer = document.getElementById('currency-list-container');
        const currencySelector = document.getElementById('currency-selector');
        const chartTitle = document.getElementById('chart-title');
        const percentageChangeEl = document.getElementById('percentage-change');
        const timeframeSelector = document.getElementById('timeframe-selector');
        const chartLoading = document.getElementById('chart-loading');

        const API_BASE = 'https://api.frankfurter.app';
        let historyChart = null; 

        const popularCurrencies = {
            'USD': { name: 'US Dollar', flag: 'ðŸ‡ºðŸ‡¸' },
            'EUR': { name: 'Euro', flag: 'ðŸ‡ªðŸ‡º' },
            'JPY': { name: 'Japanese Yen', flag: 'ðŸ‡¯ðŸ‡µ' },
            'GBP': { name: 'British Pound', flag: 'ðŸ‡¬ðŸ‡§' },
            'AUD': { name: 'Australian Dollar', flag: 'ðŸ‡¦ðŸ‡º' },
            'CAD': { name: 'Canadian Dollar', flag: 'ðŸ‡¨ðŸ‡¦' },
            'CHF': { name: 'Swiss Franc', flag: 'ðŸ‡¨ðŸ‡­' },
            'CNY': { name: 'Chinese Yuan', flag: 'ðŸ‡¨ðŸ‡³' }
        };

        function showPage(page) {
            mainPage.classList.add('hidden');
            detailPage.classList.add('hidden');
            page.classList.remove('hidden');
        }

        backButton.addEventListener('click', () => showPage(mainPage));

        // --- Main Page Logic (FIXED) ---
        async function fetchDailyChange(currencyCode) {
            try {
                // 1. Fetch the latest data to get the most recent date
                const latestResponse = await fetch(`${API_BASE}/latest?from=${currencyCode}&to=INR`);
                const latestData = await latestResponse.json();
                if (!latestData.rates || !latestData.rates.INR) throw new Error('Invalid latest data');
                const latestRate = latestData.rates.INR;
                const latestDate = new Date(latestData.date);

                // 2. Calculate the previous day from the latest available date
                const previousDate = new Date(latestDate);
                previousDate.setDate(previousDate.getDate() - 1);
                const previousDateStr = previousDate.toISOString().split('T')[0];

                // 3. Fetch historical data for that previous day
                const historicalResponse = await fetch(`${API_BASE}/${previousDateStr}?from=${currencyCode}&to=INR`);
                const historicalData = await historicalResponse.json();
                if (!historicalData.rates || !historicalData.rates.INR) throw new Error('Invalid historical data');
                const historicalRate = historicalData.rates.INR;
                
                // 4. Calculate the change
                const change = latestRate - historicalRate;
                const percentChange = (change / historicalRate) * 100;

                return {
                    rate: latestRate,
                    change: change,
                    percentChange: percentChange
                };
            } catch (error) {
                console.error(`Failed to fetch daily change for ${currencyCode}:`, error);
                return null;
            }
        }

        async function populateCurrencyList() {
            currencyListContainer.innerHTML = ''; // Clear loading message
            for (const [code, data] of Object.entries(popularCurrencies)) {
                const card = document.createElement('div');
                card.className = 'p-4 border rounded-xl shadow-sm cursor-pointer hover:shadow-md transition-shadow';
                card.innerHTML = `
                    <div class="flex items-center mb-3">
                        <span class="text-3xl mr-3">${data.flag}</span>
                        <div class="flex flex-col">
                           <span class="font-semibold text-gray-700 text-sm">${data.name}</span>
                           <span class="font-bold text-gray-800 text-lg">${code}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-gray-900 animate-pulse">--.--</div>
                        <div class="text-sm font-medium text-gray-500 animate-pulse">--- (---)</div>
                    </div>
                `;
                card.addEventListener('click', () => viewCurrencyDetails(code));
                currencyListContainer.appendChild(card);

                const dailyData = await fetchDailyChange(code);
                if (dailyData) {
                    const changeColor = dailyData.change >= 0 ? 'text-green-600' : 'text-red-600';
                    const changeSymbol = dailyData.change >= 0 ? '+' : '';
                    card.querySelector('.text-xl').classList.remove('animate-pulse');
                    card.querySelector('.text-sm').classList.remove('animate-pulse');
                    card.querySelector('.text-xl').textContent = `â‚¹${dailyData.rate.toFixed(2)}`;
                    card.querySelector('.text-sm').innerHTML = `
                        <span class="${changeColor}">
                            ${changeSymbol}${dailyData.change.toFixed(2)} (${dailyData.percentChange.toFixed(2)}%)
                        </span>
                    `;
                } else {
                     card.querySelector('.text-xl').textContent = `N/A`;
                     card.querySelector('.text-sm').textContent = `Could not load data`;
                }
            }
        }

        function populateCurrencySelector() {
            for (const code of Object.keys(popularCurrencies)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = code;
                currencySelector.appendChild(option);
            }
            currencySelector.addEventListener('change', () => {
                const selectedCurrency = currencySelector.value;
                const currentRange = document.querySelector('.timeframe-btn.bg-blue-500').dataset.range;
                updateChart(selectedCurrency, currentRange);
            });
        }

        // --- Detail Page Logic ---
        function viewCurrencyDetails(currencyCode) {
            currencySelector.value = currencyCode;
            updateChart(currencyCode, '1Y'); // Default to 1 year view
            showPage(detailPage);
        }

        timeframeSelector.addEventListener('click', (e) => {
            if (e.target.classList.contains('timeframe-btn')) {
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                e.target.classList.add('bg-blue-500', 'text-white');
                e.target.classList.remove('bg-gray-200', 'text-gray-700');
                
                const selectedCurrency = currencySelector.value;
                const selectedRange = e.target.dataset.range;
                updateChart(selectedCurrency, selectedRange);
            }
        });

        async function updateChart(currencyCode, range) {
            chartTitle.textContent = `INR vs ${currencyCode} Chart`;
            chartLoading.style.display = 'flex';
            percentageChangeEl.textContent = ''; 

            const endDate = new Date();
            let startDate = new Date();

            if (range === '1Y') {
                startDate.setFullYear(endDate.getFullYear() - 1);
            } else if (range === '5Y') {
                startDate.setFullYear(endDate.getFullYear() - 5);
            } else { 
                startDate = new Date('2000-01-01');
            }
            
            const formattedStartDate = startDate.toISOString().split('T')[0];
            const url = `${API_BASE}/${formattedStartDate}..?from=${currencyCode}&to=INR`;

            try {
                const response = await fetch(url);
                const data = await response.json();
                
                const rates = data.rates;
                const labels = Object.keys(rates).sort();
                const chartData = labels.map(date => rates[date]['INR']);

                if (chartData.length > 1) {
                    const startValue = chartData[0];
                    const endValue = chartData[chartData.length - 1];
                    const percentChange = ((endValue - startValue) / startValue) * 100;
                    const changeSymbol = percentChange >= 0 ? 'â–²' : 'â–¼';
                    const changeColor = percentChange >= 0 ? 'text-green-600' : 'text-red-600';
                    
                    percentageChangeEl.innerHTML = `
                        <span class="${changeColor}">${changeSymbol} ${percentChange.toFixed(2)}%</span>
                        <span class="text-gray-500"> (${range})</span>
                    `;
                }

                renderHistoryChart(labels, chartData, currencyCode);
            } catch (error) {
                console.error("Failed to fetch historical data:", error);
                if(historyChart) historyChart.destroy();
                chartLoading.innerHTML = `<p class="text-red-500">Could not load chart data.</p>`;
            } finally {
                chartLoading.style.display = 'none';
            }
        }

        function renderHistoryChart(labels, data, currencyCode) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            if (historyChart) {
                historyChart.destroy();
            }
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `INR per 1 ${currencyCode}`,
                        data: data,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 2,
                        pointRadius: 0,
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { 
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'month' }, grid: { display: false } },
                        y: { beginAtZero: false, grid: { color: '#e5e7eb' } }
                    },
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { 
                            enabled: true,
                            callbacks: {
                                title: function(context) {
                                    const date = new Date(context[0].parsed.x);
                                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                                },
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(4);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateCurrencyList();
            populateCurrencySelector();
            showPage(mainPage);
        });
    </script>
</body>
</html>
